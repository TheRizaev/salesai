{% extends 'dashboard/base.html' %}

{% block title %}–û–±–∑–æ—Ä{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ request.user.first_name|default:request.user.username }}! üëã</h1>
        <p class="page-subtitle">–í–æ—Ç –æ–±–∑–æ—Ä –≤–∞—à–∏—Ö —á–∞—Ç-–±–æ—Ç–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é</p>
    </div>
    <a href="{% url 'create_agent' %}" class="btn btn-primary">
        <i class="fa-solid fa-plus"></i>
        –°–æ–∑–¥–∞—Ç—å –±–æ—Ç–∞
    </a>
</div>

<!-- STATS CARDS -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-icon">
                <i class="fa-solid fa-robot"></i>
            </div>
        </div>
        <div class="stat-value">{{ active_bots }}</div>
        <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –±–æ—Ç–æ–≤</div>
        <div class="stat-change positive">
            <i class="fa-solid fa-arrow-up"></i>
            –∏–∑ {{ total_bots }} –≤—Å–µ–≥–æ
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-icon" style="background: rgba(168, 85, 247, 0.1); color: var(--accent-secondary);">
                <i class="fa-solid fa-comments"></i>
            </div>
        </div>
        <div class="stat-value">{{ total_conversations|default:0 }}</div>
        <div class="stat-label">–î–∏–∞–ª–æ–≥–æ–≤ –∑–∞ –Ω–µ–¥–µ–ª—é</div>
        <div class="stat-change positive">
            <i class="fa-solid fa-arrow-up"></i>
            +{{ total_messages|default:0 }} —Å–æ–æ–±—â–µ–Ω–∏–π
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-icon" style="background: rgba(34, 197, 94, 0.1); color: #22c55e;">
                <i class="fa-solid fa-user-plus"></i>
            </div>
        </div>
        <div class="stat-value">{{ total_leads|default:0 }}</div>
        <div class="stat-label">–ó–∞—Ö–≤–∞—á–µ–Ω–æ –ª–∏–¥–æ–≤</div>
        <div class="stat-change positive">
            <i class="fa-solid fa-arrow-up"></i>
            +{{ total_leads|default:0 }} –∑–∞ –Ω–µ–¥–µ–ª—é
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                <i class="fa-solid fa-percent"></i>
            </div>
        </div>
        <div class="stat-value">{% if total_conversations %}{{ total_leads|default:0|floatformat:0|mul:100|div:total_conversations|floatformat:1 }}%{% else %}0%{% endif %}</div>
        <div class="stat-label">–ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –ª–∏–¥—ã</div>
        <div class="stat-change positive">
            <i class="fa-solid fa-arrow-up"></i>
            +2.1% –∫ –ø—Ä–æ—à–ª–æ–π –Ω–µ–¥–µ–ª–µ
        </div>
    </div>
</div>

<!-- BOTS LIST -->
<div class="glass-card">
    <div class="card-header">
        <h2 class="card-title">
            <i class="fa-solid fa-robot"></i>
            –í–∞—à–∏ –±–æ—Ç—ã
        </h2>
        <a href="{% url 'agents_list' %}" class="btn btn-secondary" style="padding: 8px 16px; font-size: 0.9rem;">
            –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ
            <i class="fa-solid fa-arrow-right"></i>
        </a>
    </div>

    {% if bots %}
        <div class="agents-grid">
            {% for bot in bots|slice:":3" %}
                <div class="agent-card" onclick="window.location.href='{% url 'agent_detail' bot.id %}'">
                    <div class="agent-header">
                        <div class="agent-avatar">
                            {% if bot.platform == 'telegram' %}
                                <i class="fa-brands fa-telegram" style="color: #229ED9;"></i>
                            {% elif bot.platform == 'whatsapp' %}
                                <i class="fa-brands fa-whatsapp" style="color: #25D366;"></i>
                            {% elif bot.platform == 'vk' %}
                                <i class="fa-brands fa-vk" style="color: #0077FF;"></i>
                            {% else %}
                                <i class="fa-solid fa-robot"></i>
                            {% endif %}
                        </div>
                        <div class="agent-info">
                            <h3>{{ bot.name }}</h3>
                            <div class="agent-platform">
                                <i class="fa-solid fa-circle" style="font-size: 0.4rem;"></i>
                                {{ bot.get_platform_display }}
                            </div>
                        </div>
                    </div>

                    <div style="margin: 15px 0;">
                        <span class="status-badge {% if bot.status == 'active' %}active{% else %}inactive{% endif %}">
                            <span class="status-dot"></span>
                            {% if bot.status == 'active' %}–ê–∫—Ç–∏–≤–µ–Ω{% else %}–ù–µ–∞–∫—Ç–∏–≤–µ–Ω{% endif %}
                        </span>
                    </div>

                    <div class="agent-stats">
                        <div class="agent-stat">
                            <span class="agent-stat-value">{{ bot.total_conversations }}</span>
                            <span class="agent-stat-label">–î–∏–∞–ª–æ–≥–æ–≤</span>
                        </div>
                        <div class="agent-stat">
                            <span class="agent-stat-value">{{ bot.total_messages }}</span>
                            <span class="agent-stat-label">–°–æ–æ–±—â–µ–Ω–∏–π</span>
                        </div>
                        <div class="agent-stat">
                            <span class="agent-stat-value">{{ bot.conversion_rate }}%</span>
                            <span class="agent-stat-label">–ö–æ–Ω–≤–µ—Ä—Å–∏—è</span>
                        </div>
                    </div>

                    <div class="agent-actions">
                        <button class="btn-icon" onclick="event.stopPropagation(); toggleBotStatus({{ bot.id }})" title="–í–∫–ª—é—á–∏—Ç—å/–í—ã–∫–ª—é—á–∏—Ç—å">
                            <i class="fa-solid fa-power-off"></i>
                        </button>
                        <button class="btn-icon" onclick="event.stopPropagation(); window.location.href='{% url 'agent_detail' bot.id %}'" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                            <i class="fa-solid fa-gear"></i>
                        </button>
                        <button class="btn-icon btn-danger" onclick="event.stopPropagation(); deleteBot({{ bot.id }})" title="–£–¥–∞–ª–∏—Ç—å">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fa-solid fa-robot"></i>
            </div>
            <h3 class="empty-title">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –±–æ—Ç–æ–≤</h3>
            <p class="empty-text">
                –°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–µ–≥–æ –ø–µ—Ä–≤–æ–≥–æ —á–∞—Ç-–±–æ—Ç–∞ –∏ –Ω–∞—á–Ω–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏
            </p>
            <a href="{% url 'create_agent' %}" class="btn btn-primary">
                <i class="fa-solid fa-plus"></i>
                –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤–æ–≥–æ –±–æ—Ç–∞
            </a>
        </div>
    {% endif %}
</div>

<!-- RECENT CONVERSATIONS -->
{% if recent_conversations %}
<div class="glass-card">
    <div class="card-header">
        <h2 class="card-title">
            <i class="fa-solid fa-clock"></i>
            –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∏
        </h2>
        <a href="{% url 'conversations_list' %}" class="btn btn-secondary" style="padding: 8px 16px; font-size: 0.9rem;">
            –í—Å–µ –¥–∏–∞–ª–æ–≥–∏
            <i class="fa-solid fa-arrow-right"></i>
        </a>
    </div>

    <table class="data-table">
        <thead>
            <tr>
                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                <th>–ë–æ—Ç</th>
                <th>–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for conv in recent_conversations %}
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 35px; height: 35px; border-radius: 50%; background: rgba(99, 102, 241, 0.1); display: flex; align-items: center; justify-content: center; color: var(--accent-primary);">
                                <i class="fa-solid fa-user"></i>
                            </div>
                            <div>
                                <div style="font-weight: 500; color: white;">{{ conv.user_name|default:"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" }}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">{{ conv.user_id }}</div>
                            </div>
                        </div>
                    </td>
                    <td>{{ conv.bot.name }}</td>
                    <td style="color: var(--text-secondary); font-size: 0.9rem;">{{ conv.last_message_at|timesince }} –Ω–∞–∑–∞–¥</td>
                    <td>
                        {% if conv.is_lead %}
                            <span class="status-badge" style="background: rgba(34, 197, 94, 0.1); color: #22c55e; border-color: rgba(34, 197, 94, 0.3);">
                                <i class="fa-solid fa-check"></i> –õ–∏–¥
                            </span>
                        {% else %}
                            <span class="status-badge inactive">
                                <i class="fa-solid fa-comment"></i> –î–∏–∞–ª–æ–≥
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{% url 'conversation_detail' conv.id %}" class="btn-icon">
                            <i class="fa-solid fa-eye"></i>
                        </a>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<script>
function toggleBotStatus(botId) {
    if (!confirm('–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞?')) return;
    
    fetch(`/api/agents/${botId}/toggle/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        }
    })
    .catch(error => console.error('Error:', error));
}

function deleteBot(botId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;
    
    fetch(`/api/agents/${botId}/delete/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        }
    })
    .catch(error => console.error('Error:', error));
}
</script>
{% endblock %}
